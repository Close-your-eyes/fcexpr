---
title: "import data from fj workspaces"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{import data from fj workspaces}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(knitr.kable.NA = '', width = 80)
library(flowWorkspace)
library(CytoML)
```

Install necessary packages in RStudio:
```{r setup, eval=F,message=F}
install.packages("devtools")
devtools::install_github("Close-your-eyes/fcexpr")
install.packages("tidyverse")
library(fcexpr)
```
```{r setup2, message=F}
library(tidyverse)
```

Many information are stored in flowjos wsp file which is actually an xml file. This includes gated event counts, statistics like MFI and meta data from the FCS files like keywords. The wsp file can be accessed without a flowjo dongle - you can open the it with in a text editor (e.g. [BB Edit](https://www.barebones.com/products/bbedit/index.html) on a Mac) or read it with the XML2 package in R.   
Based on the latter I wrote functions that extract information from a flowjo 10 wsp.It is very simple and works as follows. After you gated your populations, save the wsp and run the wsx_get_popstats function:

```{r,include=F}
dir <- base::system.file("extdata", package = "fcexpr")
utils::untar(base::system.file("extdata", "Part_3.tgz", package = "fcexpr"), exdir = dir)
wd <- file.path(dir, "Part_3")
ws <- list.files(file.path(wd, "FJ_workspace"), full.names = T)
sd <- openxlsx::read.xlsx(file.path(dir, "Part_3", "sampledescription.xlsx"))
ps <- fcexpr::wsx_get_popstats(ws, return_stats = T)
```

```{r, eval=F}
ps <- fcexpr::wsx_get_popstats(ws = "/Users/user/Documents/07-Oct-2021.wsp", return_stats = TRUE)
# also ps <- wsx_get_popstats(ws = "/Users/user/Documents/07-Oct-2021.wsp") is possible
```

ws is the file path (url) to a wsp on your disk. The prefix fcexpr:: specifies the package a function comes from.
With return_stats = TRUE a list of length 2 is returned.

```{r}
length(ps)
```

Index 1 holds a data frame with gated event counts. Index 2 holds, if calculated in flowjo, statistics like MFI. If not, then index 2 is NULL.

```{r}
names(ps)
# columns names
names(ps[[1]])
names(ps[[2]])
```

You may write the list-content to individual variables. This will allow to inspect the data frames manually in R studio.

```{r}
ps_counts <- ps[["counts"]] # access by name
ps_stats <- ps[[2]] # access by index
```

Most likely additional information (meta data) are necessary to plot the data or analyze them statistically. One has to attach information about every fcs files like if it was a full stain, FMO or isotype control; or from which patient the sample material was derived; or what disease the patient suffered from; sex or age. This may be achieved by joining a sampledescription to ps_counts or ps_stats. You may create such table manually or have it created in a standardized, automized fashion with **fcexpr::sync_sampldescription** (see another vignette for the whole concept). Alternatively, your wsp may hold annotations in the form of keywords. These can be extracted as well:

```{r}
keys <- fcexpr::wsx_get_keywords(ws)
```

This returns a list of data frames. One index for every FCS file in the wsp. In this example there are 48 FCS files. The data frame at index 1 (first FCS file) has 211 rows, one for each keyword, and 2 columns, providing the name of the keyword and its value.
```{r}
length(keys)
nrow(keys[[1]])
names(keys[[1]])
```

To join the keywords to ps_counts or ps_stats we have to make it a data.frame first.
```{r}
# make it a data.frame
keys_df <- do.call(rbind, keys) # base R
keys_df <- dplyr::bind_rows(keys) # dplyr-style
# create a FileName-column
keys_df$FileName <- rep(names(keys), sapply(keys,nrow))
# select relevant keywords
# example: Cytometer name ($CYT) and Operator ($OP)
keys_df <- keys_df[which(keys_df$name %in% c("$CYT", "$OP")),] # base R
keys_df <- dplyr::filter(keys_df, name %in% c("$CYT", "$OP")) # dplyr-style
# make it a wider data.frame (pivot_wider and pivot_longer are a bit difficult to get your head around but are very powerful)
keys_df <- tidyr::pivot_wider(keys_df, names_from = name, values_from = value)
nrow(keys_df)
names(keys_df)
```

Now we have one data frame of two keywords for every FCS file. Join these meta data to the phenotype data. CYT and OP are just two examples but are not very informative. Hence, we also join another table (variable sd) with more relevant meta data. In this case a transduction was established and putative relevant factors that influence the transduction efficiency have been varied (see the column names of sd below).
```{r}
ps_counts2 <- merge(ps_counts, keys_df) # base R
ps_counts2 <- dplyr::left_join(ps_counts, keys_df) # dplyr-style
# sd is a sampledescription data.frame
names(sd)
ps_counts2 <- dplyr::left_join(ps_counts2, sd)
```

ps_counts2 which now holds meta data and phenotype data may be saved to excel for further processing.
```{r, eval=F}
openxlsx::write.xlsx(ps_counts2, "/Users/user/Documents/7-Oct-2021.xlsx")
```

It is preferable though to tidy up, filter, select and plot in R. This can be done with base R or with functions from the [tidyverse](https://www.tidyverse.org). It requires a little bit of practice. For a number of cases though there are a few standard procedures that you may learn quickly. Some arbitrary operations and plots are shown below.

```{r,fig.width=8}
# filter for the GFP+ population only
unique(ps_counts2$Population)
ps_counts2_plot <-
  ps_counts2 %>%
  dplyr::filter(Population == "GFP+")
unique(ps_counts2_plot$Population)
# plot the frequency of GFP+ events with respect to the parent gate
ggplot(ps_counts2_plot, aes(x = incubation.time.h, y = FractionOfParent)) +
  geom_jitter(width = 0.1) +
  theme_bw() +
  ylab("% GFP+ in DAPI-")
```

The incubation time of viral supernatant (x-axis) seems to play a role for the transduction rate (y-axis). But there are more factors which can be visualized in another plot.

```{r, include=F}
ps_counts2_plot$incubation.time.h <- factor(ps_counts2_plot$incubation.time.h, levels = sort(as.numeric(unique(ps_counts2_plot$incubation.time.h))))
ps_counts2_plot$EGF.ng.ml <- factor(ps_counts2_plot$EGF.ng.ml, levels = sort(as.numeric(unique(ps_counts2_plot$EGF.ng.ml))))
ps_counts2_plot$seeding.density.dilution <- factor(ps_counts2_plot$seeding.density.dilution, levels = sort(as.numeric(unique(ps_counts2_plot$seeding.density.dilution))))
ps_counts2_plot$viral.sup.vol.µl <- factor(ps_counts2_plot$viral.sup.vol.µl, levels = sort(as.numeric(unique(ps_counts2_plot$viral.sup.vol.µl))))
```


```{r,fig.width=8}
ggplot(ps_counts2_plot, aes(x = viral.sup.vol.µl, y = seeding.density.dilution, fill = FractionOfParent)) +
  geom_tile(color = "black") +
  theme_classic() +
  scale_fill_viridis_c() +
  facet_grid(cols = vars(incubation.time.h), rows = vars(FCS.percent))
```


```{r, echo=F}
unlink(wd, recursive = T)
```
