---
title: "import data from fj workspaces"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{import data from fj workspaces}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(knitr.kable.NA = '', width = 80)
library(flowWorkspace)
library(CytoML)
```

Install necessary packages in RStudio:
```{r setup, eval=F,message=F}
install.packages("devtools")
devtools::install_github("Close-your-eyes/fcexpr")
install.packages("tidyverse")
library(fcexpr)
```

```{r setup2, message=F}
library(tidyverse)
```

Pick a directory to run the example on your disk.
```{r, echo=F}
dir <- "/Users/vonskopnik/Documents"
utils::untar(base::system.file("extdata", "Part_3.tgz", package = "fcexpr"), exdir = dir)
wd <- file.path(dir, "Part_3")
```

This is a minimal experiment folder. FCS files and a sampledescription.xlsx have already been synchronized.  
A renal epithelial cell line (RPTEC) has been retrovirally transduced with GFP. Cells have then analyzed by flow cytometry. Factors have been varied (see below) that may or may not impact the transduction rate. Which and how? - This is what we want to know.
```{r}
list.files(wd, recursive = T)[1:5]
```

```{r}
knitr::kable(head(openxlsx::read.xlsx(file.path(wd, "sampledescription.xlsx")), 5))
```

When running an R-script which is saved in the R_script folder on can have its directory determined with an R command (only from RStudio). This command does not work in this tutorial, so it is commented (#).
```{r}
# wd <- dirname(dirname(rstudioapi::getActiveDocumentContext()$path))
```

Find all the flowjo workspaces in the folder.
```{r}
# the pattern indicates that .wsp has to appear at the end of the file name
ws <- list.files(path = wd, pattern = "\\.wsp$", recursive = T, full.names = T)
ws
```

Under the hood, the .wsp file is an XML file with all population counts and statistics stored. (independently of FCS files)
![alt text](vignettes/5qdab0.jpg)

Import the aggregated values from a workspace file with wsx_get_popstats. When return_stats = T (default) a list is returned. Index 1 has a data.frame with event counts, index 2 has a data.frame with statistics like MFI or standard deviation calculated in FlowJo.
```{r}
ps.raw <- fcexpr::wsx_get_popstats(ws[1])
knitr::kable(head(ps.raw[[1]], 10))
```

The gating for GFP positive events is straight forward.
![alt text](vignettes/gating.png)

Join and organize the data with the meta data which are documented in the sampledescription.xlsx with functions from the dplyr package. As FCS file names and the FileName column in our sampledescription.xlsx have been synchronized before, we can use this column for joining.
```{r}
sd <- openxlsx::read.xlsx(file.path(wd, "sampledescription.xlsx"))
knitr::kable(head(sd, 10))

ps <-
  ps.raw[[1]] %>%
  dplyr::left_join(sd, by = "FileName")
knitr::kable(head(ps, 10))
```

This table can be saved as xlsx if needed.
```{r}
openxlsx::write.xlsx(ps, file.path(wd, "pop_counts.xlsx"), overwrite = T)
```

But actually plotting the data should be done in R with ggplot2.
We are most interested in the GFP+ frequency. But also the frequency of DAPI- events can be plotted with almost the same commands.
```{r}
ps_sub <-
  ps %>%
  dplyr::filter(Population == "GFP+")
```

```{r, fig.width=8}
ps_sub$incubation.time.h <- factor(ps_sub$incubation.time.h, levels = sort(as.numeric(unique(ps_sub$incubation.time.h))))
ps_sub$EGF.ng.ml <- factor(ps_sub$EGF.ng.ml, levels = sort(as.numeric(unique(ps_sub$EGF.ng.ml))))
ps_sub$seeding.density.dilution <- factor(ps_sub$seeding.density.dilution, levels = sort(as.numeric(unique(ps_sub$seeding.density.dilution))))
ps_sub$viral.sup.vol.µl <- factor(ps_sub$viral.sup.vol.µl, levels = sort(as.numeric(unique(ps_sub$viral.sup.vol.µl))))

# note how we are visualizing 4 dimension at once (4 columns in the data.frame):
# (i) viral.sup.vol.µl (x)
# (ii) seeding.density.dilution (y)
# (iii) incubation.time.h (panels or facets, the boxes on top)
# (iv) FractionOfParent (colour, or z)
ggplot(ps_sub, aes(x = viral.sup.vol.µl, seeding.density.dilution, fill = FractionOfParent)) +
  geom_tile(color = "black") +
  theme_classic() +
  scale_fill_viridis_c() +
  facet_wrap(vars(incubation.time.h))

# actually we have ignored a fifth variable, (v) the amount FCS used (FCS.percent)
# adding this one to the plot is also not complicated (boxes to the right)
ggplot(ps_sub, aes(x = viral.sup.vol.µl, seeding.density.dilution, fill = FractionOfParent)) +
  geom_tile(color = "black") +
  theme_classic() +
  scale_fill_viridis_c() +
  facet_grid(cols = vars(incubation.time.h), rows = vars(FCS.percent))

```


We can assume that the seeding density plays a role in terms of GFP transduction rate. Low seeding density (~high seeding density dilution) means that epithelial cells have space to proliferate. (Gamma-)Retrovirusses require proliferating cells to infect them. So, this observation can be explained. More viral sup increases the transduction rate in some cases. Longer incubation times of viral sup and target cells also seem to have a positive effect. As the FCS files used here have been downsampled to keep the fcexpr-package small results are skewed due to the random sampling.

Another relevant read-out are MFIs. All statistics calculated in FlowJo are saved in the .wsp (~XML) file and hence, can be extracted easily even without the underlying FCS files. If there are none, ps.raw[["stats"]] is NULL.

```{r}
stats <- ps.raw[["stats"]]
```

This table may be appended with additional columns from the data.frame with event counts additional meta data from sampledescription.

```{r}
stats <-
  stats %>%
  dplyr::left_join(ps.raw[["counts"]]) %>%
  dplyr::left_join(sd, by = "FileName")
```

GFP emits into the FITC channel (b-LP502 530_30-E-A), so this is the one we are interested in.
```{r, fig.width=8}
stats <-
  stats %>%
  dplyr::filter(channel == "b-LP502 530_30-E-A") %>%
  dplyr::filter(statistic == "Median") %>%
  dplyr::mutate(incubation.time.h = factor(incubation.time.h, levels = sort(as.numeric(unique(incubation.time.h))))) %>%
  dplyr::mutate(EGF.ng.ml = factor(EGF.ng.ml, levels = sort(as.numeric(unique(EGF.ng.ml))))) %>%
  dplyr::mutate(seeding.density.dilution = factor(seeding.density.dilution, levels = sort(as.numeric(unique(seeding.density.dilution))))) %>%
  dplyr::mutate(viral.sup.vol.µl = factor(viral.sup.vol.µl, levels = sort(as.numeric(unique(viral.sup.vol.µl)))))
  
ggplot(stats, aes(x = viral.sup.vol.µl, seeding.density.dilution, fill = value)) +
  geom_tile(color = "black") +
  theme_classic() +
  scale_fill_viridis_c() +
  facet_grid(cols = vars(incubation.time.h), rows = vars(FCS.percent))
```

There seems to be a significant higher GFP-MFI for RPTECs that have been incubated with the high-level of viral sup (150 µl) and for 48 hours. On the other hand, according to the legend, it is only a 2- to 3-fold difference to other conditions which is not so much in flow cytometry. In order to better judge this, looking at histograms may be helpful.  
To do so, whole FCS files have to be imported though. So one needs the information about gated events from a .wsp-file and the FCS files. That will be part of another vignette.


```{r, echo=F}
unlink(wd, recursive = T)
```
