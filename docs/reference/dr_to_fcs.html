<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Calculate dimension reductions and cluster annotations with data from one or more flow frames and add these parameters to a (concatenated) fcs file — dr_to_fcs • fcexpr</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Calculate dimension reductions and cluster annotations with data from one or more flow frames and add these parameters to a (concatenated) fcs file — dr_to_fcs"><meta property="og:description" content="Prepare a list of flowframes (ff.list) with fcexpr::wsp_get_ff or fcexpr::inds_get_ff. The objects returned from these function will compatible with fcexpr::dr_to_fcs.
The list must contain logicle transformed fluorescence intensities (FI) and optionally may contain corresponding inverse transformed FI (which is the transformation you see in flowjo).
For dimension reduction logicle transformed FI are used. Currently, this is obligatory. This transformation, optionally additional scaling operations alogn the way (scale.whole, scale.samples)
as well as cluster annotation will be written to the resulting (concatenated) fcs file for manual inspection in flowjo. Certain dimension reduction algorithms and cluster detection algorithm
may become slow with a large number of events (e.g. &amp;gt; 1e6, see the details). In order to get a quick impression of what the algorithms can pull out for you, you may use the 'downsample'
argument in fcexpr::wsp_get_ff or fcexpr::inds_get_ff to conveniently sample a random subset of events from each fcs files (flowframe)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fcexpr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9950</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/create_and_maintain_a_meta_data_table.html">create_and_maintain_a_meta_data_table</a>
    </li>
    <li>
      <a href="../articles/import_data_from_fj_workspaces.html">import data from FlowJo workspaces</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Calculate dimension reductions and cluster annotations with data from one or more flow frames and add these parameters to a (concatenated) fcs file</h1>
    
    <div class="hidden name"><code>dr_to_fcs.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Prepare a list of flowframes (ff.list) with fcexpr::wsp_get_ff or fcexpr::inds_get_ff. The objects returned from these function will compatible with fcexpr::dr_to_fcs.
The list must contain logicle transformed fluorescence intensities (FI) and optionally may contain corresponding inverse transformed FI (which is the transformation you see in flowjo).
For dimension reduction logicle transformed FI are used. Currently, this is obligatory. This transformation, optionally additional scaling operations alogn the way (scale.whole, scale.samples)
as well as cluster annotation will be written to the resulting (concatenated) fcs file for manual inspection in flowjo. Certain dimension reduction algorithms and cluster detection algorithm
may become slow with a large number of events (e.g. &gt; 1e6, see the details). In order to get a quick impression of what the algorithms can pull out for you, you may use the 'downsample'
argument in fcexpr::wsp_get_ff or fcexpr::inds_get_ff to conveniently sample a random subset of events from each fcs files (flowframe).</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">dr_to_fcs</span><span class="op">(</span>
  <span class="va">ff.list</span>,
  channels <span class="op">=</span> <span class="cn">NULL</span>,
  add.sample.info <span class="op">=</span> <span class="cn">NULL</span>,
  scale.whole <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"z.score"</span>, <span class="st">"min.max"</span>, <span class="st">"none"</span><span class="op">)</span>,
  scale.samples <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"z.score"</span>, <span class="st">"min.max"</span><span class="op">)</span>,
  run.harmony <span class="op">=</span> <span class="cn">F</span>,
  run.pca <span class="op">=</span> <span class="cn">F</span>,
  run.lda <span class="op">=</span> <span class="cn">F</span>,
  run.umap <span class="op">=</span> <span class="cn">T</span>,
  run.tsne <span class="op">=</span> <span class="cn">F</span>,
  run.som <span class="op">=</span> <span class="cn">T</span>,
  run.gqtsom <span class="op">=</span> <span class="cn">F</span>,
  run.louvain <span class="op">=</span> <span class="cn">F</span>,
  run.kmeans <span class="op">=</span> <span class="cn">F</span>,
  run.minibatchkmeans <span class="op">=</span> <span class="cn">F</span>,
  run.kmeans_arma <span class="op">=</span> <span class="cn">F</span>,
  run.kmeans_rcpp <span class="op">=</span> <span class="cn">F</span>,
  run.leiden <span class="op">=</span> <span class="cn">F</span>,
  run.hclust <span class="op">=</span> <span class="cn">F</span>,
  run.flowClust <span class="op">=</span> <span class="cn">F</span>,
  run.MUDAN <span class="op">=</span> <span class="cn">F</span>,
  n.pca.dims <span class="op">=</span> <span class="fl">0</span>,
  calc.cluster.markers <span class="op">=</span> <span class="cn">NULL</span>,
  extra.cols <span class="op">=</span> <span class="cn">NULL</span>,
  mc.cores <span class="op">=</span> <span class="fl">1</span>,
  save.to.disk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fcs"</span>, <span class="st">"rds"</span><span class="op">)</span>,
  save.path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="st">""</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/make.names.html" class="external-link">make.names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">15</span><span class="op">)</span>, <span class="st">"_FCS_dr"</span><span class="op">)</span><span class="op">)</span>,
  exclude.extra.channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ff.list</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ff.list</span><span class="op">)</span> <span class="op">==</span> <span class="st">"logicle"</span>,
    <span class="st">"cluster.id"</span>, <span class="st">"FSC|SSC|Time|cluster.id"</span><span class="op">)</span>,
  write.scaled.channels.to.FCS <span class="op">=</span> <span class="cn">F</span>,
  timeChannel <span class="op">=</span> <span class="st">"Time"</span>,
  <span class="va">...</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>ff.list</dt>
<dd><p>a list of flowFrames as received from fcexpr::wsp_get_ff (compensated with Compensation Matrix as defined in FlowJo by default) or
as received from fcexpr::inds_get_ff (directly from FCS files, not compensated by default)</p></dd>
<dt>channels</dt>
<dd><p>a named vector of channels to use for dimension reduction. values can be channel names (v-450LP..., b-520..., or so), or channel descriptions (e.g. CD3 or LAG3-PeCy7 for example)
names will be used as new description in the fcs file to be written; if no names provided, names of the very first FCS file will be used</p></dd>
<dt>add.sample.info</dt>
<dd><p>named list of additional channels to identify samples or group them in flowjo;
e.g. for 9 fcs files to be concatenated: add.sample.info = list(condition = c(1,2,3,1,2,3,1,2,3), donor = c(1,1,1,2,2,2,3,3,3))</p></dd>
<dt>scale.whole</dt>
<dd><p>if and how to scale channels after concatenation of flowframes in ff.list</p></dd>
<dt>scale.samples</dt>
<dd><p>if and how to scale channels of flowframes in ff.list individually before concatenation</p></dd>
<dt>run.harmony</dt>
<dd><p>attempt batch correction using harmony::HarmonyMatrix; if TRUE, then harmony__meta_data has to be provided in ... indicating the groups to be batch corrected;
harmony is conducted before run.pca; to calculate a pca before harmony, pass harmony__do_pca = T and optional a number of pcs with harmony__npcs. Set run.pca = F
when a pca is before in harmony.</p></dd>
<dt>run.pca</dt>
<dd><p>run principle component analysis only, or prior to other dimension reduction (umap, SOM, tSNE, ...)</p></dd>
<dt>run.lda</dt>
<dd><p>run Linear Discriminant Analysis before dimension reduction;
should be F (FALSE) or a clustering calculated before, e.g. louvain_0.8 or leiden_1.1, kmeans_12 etc.; respective clustering calculation
has to be provided in ...</p></dd>
<dt>run.umap</dt>
<dd><p>calculate UMAP dimension reduction with uwot::umap</p></dd>
<dt>run.tsne</dt>
<dd><p>calculate tsne dimension reduction with Rtsne::Rtsne</p></dd>
<dt>run.som</dt>
<dd><p>calculate SOM dimension reduction EmbedSOM::SOM followed by EmbedSOM::EmbedSOM</p></dd>
<dt>run.gqtsom</dt>
<dd><p>calculate GQTSOM dimension reduction EmbedSOM::GQTSOM followed by EmbedSOM::EmbedSOM</p></dd>
<dt>run.louvain</dt>
<dd><p>detect clusters (communities, groups) of cells with the louvain algorithm, implemented in Seurat::FindClusters (subsequent to snn detection by Seurat::FindNeighbors)</p></dd>
<dt>run.kmeans</dt>
<dd><p>detect clusters with stats::kmeans</p></dd>
<dt>run.minibatchkmeans</dt>
<dd><p>detect clusters with ClusterR::MiniBatchKmeans</p></dd>
<dt>run.kmeans_arma</dt>
<dd><p>detect clusters with ClusterR::KMeans_arma</p></dd>
<dt>run.kmeans_rcpp</dt>
<dd><p>detect clusters with ClusterR::KMeans_rcpp</p></dd>
<dt>run.leiden</dt>
<dd><p>detect clusters (communities, groups) of cells with the leiden algorithm, with leiden::leiden (subsequent to snn detection by Seurat::FindNeighbors)</p></dd>
<dt>run.hclust</dt>
<dd><p>detect clusters with stats::dist, stats::hclust and stats::cutree</p></dd>
<dt>run.flowClust</dt>
<dd><p>detect clusters with flowClust::flowClust</p></dd>
<dt>run.MUDAN</dt>
<dd><p>detect clusters with MUDAN::getComMembership</p></dd>
<dt>n.pca.dims</dt>
<dd><p>number of principle components to calculate</p></dd>
<dt>calc.cluster.markers</dt>
<dd><p>if NULL nothing is calculated; otherwise marker features (stained markers) are determined by wilcox test
using <a href="https://github.com/immunogenomics/presto" class="external-link">presto::wilcoxauc</a> for the provided clustering(s). each cluster
is tested against other events and clusters are compaired pairwise. respective clustering calculation has to be provided in ...;
e.g. if louvain__resolution = 0.5 is provided set calc.cluster.markers = louvain_0.5;
and if in addition leiden__resolution_parameter = 0.7 then set calc.cluster.markers = c(louvain_0.5, leiden_0.7).</p></dd>
<dt>extra.cols</dt>
<dd><p>vector of one extra column (or matrix of multiple columns) to add to the final fcs file;
has to be numeric; has to be equal to the number of rows in all flowframes provided; colnames will be the channel names in the FCS file;
could be a previously calculated dimension reduction or cluster annotation.</p></dd>
<dt>mc.cores</dt>
<dd><p>mc.cores to calculate clusterings, limited to parallel::detectCores()-1</p></dd>
<dt>save.to.disk</dt>
<dd><p>what to save to disk: (concatenated) and appended FCS file and/or rds file with several elements in a list</p></dd>
<dt>save.path</dt>
<dd><p>where to save elements specified in save.to.disk; set to NULL to have nothing written to disk</p></dd>
<dt>exclude.extra.channels</dt>
<dd><p>when scaled and transform channels are written to FCS file, some channels may be redundant
and will only occupy disk space, those are specified here; matched with grepl</p></dd>
<dt>write.scaled.channels.to.FCS</dt>
<dd><p>do save scaled channels (scale.whole, scale.samples) to FCS file</p></dd>
<dt>timeChannel</dt>
<dd><p>name of the Time channel to exclude from all analyses and calculation; if NULL will be attempted
to be detected automatically</p></dd>
<dt>...</dt>
<dd><p>additional parameters to calculations of <a href="https://github.com/jlmelville/uwot" class="external-link">UMAP</a>, <a href="https://github.com/jkrijthe/Rtsne" class="external-link">tSNE</a>, <a href="https://github.com/exaexa/EmbedSOM" class="external-link">SOM, GQTSOM, EmbedSOM</a>, louvain, <a href="https://github.com/TomKellyGenetics/leiden" class="external-link">leiden</a>,
<a href="https://github.com/immunogenomics/harmony" class="external-link">harmony</a>, <a href="https://www.bioconductor.org/packages/release/bioc/html/flowClust.html" class="external-link">flowClust</a>, hclust, <a href="https://github.com/JEFworks/MUDAN" class="external-link">MUDAN</a>, kmeans;
provide arguments as follows: UMAP__n_neighbors = c(15,20,25), or tsne__theta = 0.3, etc.
see respected help files to get to know which arguments can be passed:
uwot::umap, Rtsne::Rtsne, EmbedSOM::SOM, EmbedSOM::GQTSOM, EmbedSOM::EmbedSOM, harmony::HarmonyMatrix, flowClust::flowClust,
louvain: Seurat::FindNeighbors and Seurat::FindCluster, leiden: Seurat::FindNeighbors and leiden::leiden.
hclust: stats::dist and stats::hclust, MUDAN: MUDAN::getComMembership, stats::kmeans,
ClusterR::MiniBatchKmeans, ClusterR::KMeans_rcpp, ClusterR::KMeans_arma</p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>A list with 3 elements: (i) The matrix of fluorescence intensities and appended information (dim red, clustering). This is the table which is written into a newly generated fcs file.
(ii) A character vector of meaningful column names which may be used for the table in R (rather for convenience). (iii) Tables of marker features (each cluster vs all other events and all clusters pairwise).</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>Logicle transformation of FI has been described here: <a href="https://pubmed.ncbi.nlm.nih.gov/16604519/" class="external-link">Parks, et al., 2006, PMID: 16604519  DOI: 10.1002/cyto.a.20258</a>.
Different transformations have been compared for instance here: <a href="https://dillonhammill.github.io/CytoExploreR/articles/CytoExploreR-Transformations.html" class="external-link">Transformations</a>.
Dimension reduction (low dimension embedding) algorithms are: UMAP, tSNE, SOM, GQTSOM, PCA. tSNE is expected to be too slow for more then 1e4 or 1e5 cells (depending
precision set by tsne__theta). UMAP has been developed later and is well-know. SOM and GQTSOM are similar to <a href="https://github.com/SofieVG/FlowSOM" class="external-link">flowSOM</a>
but are much more convenient to use in programming as they accept matrices whereas flowSOM strictly requires flowFrames. Also SOM and GQTSOM may be superior with
respect to calculation speed. <a href="%22https://www.youtube.com/watch?v=FgakZw6K1QQ%22" class="external-link">PCA</a> will be orders of magnitude faster than UMAP especially on large numbers of events (1e6 and above).
On the other hand it will not produce as nicely separated clusters as it is a linear algorithm.
Cluster (community) detection algorithms are louvain, leiden, kmeans, hclust, flowClust and MUDAN. These assign events with similar properties in the high dimensional space a common discrete label. kmeans will be the quickest.
Start with this one and progress to using louvain which is slower but may yield better results. For a low number of events (e.g. below 1e6) louvain will perform in a reasonable amount of time
and could used immediately in parallel to kmeans. leiden will require the original python library and is approximately similar to louvain with respect to calculation time,
maybe a bit slower. leiden is an enhancement of louvain, though louvain does not produce "wrong" results per se. flowClust, MUDAN, and hclust have not been tested extensively.
For kmeans, hclust, flowClust the number of expected cluster can be provided. louvain and leiden take a resolution parameter (lower resolution --&gt; less clusters). MUDAN takes
the a number of nearest neighbors (less neighbors --&gt; more clusters).
An initial PCA may not be required if the selected channels are chosen thoughtfully (only those with stained markers). If you decide though to simply
use all channels (with and and without stained marker) for dimension reduction, PCA will automatically lead to focus on the ones with highest variation (so those channels which contain staining
on a subset of events). In this case you may set n.pca.dims roughly equal to the number of channels which contain a staining.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in"><span class="co">############################</span></span>
<span class="r-in"><span class="co">### Plot cluster markers ###</span></span>
<span class="r-in"><span class="co">############################</span></span>
<span class="r-in"><span class="va">dr</span> <span class="op">&lt;-</span> <span class="fu">fcexpr</span><span class="fu">::</span><span class="fu">dr_to_fcs</span><span class="op">(</span>ff.list <span class="op">=</span> <span class="va">ffs</span>,</span>
<span class="r-in">channels <span class="op">=</span> <span class="va">channels</span>,</span>
<span class="r-in">louvain__resolution <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span class="r-in">run.lda <span class="op">=</span> <span class="st">"louvain_0.5"</span>,</span>
<span class="r-in">calc.cluster.markers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"louvain_0.5"</span><span class="op">)</span>,</span>
<span class="r-in">save.path <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span class="r-in"><span class="va">marker</span> <span class="op">&lt;-</span> <span class="va">dr</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span class="r-in"><span class="va">marker</span><span class="op">$</span><span class="va">channel_desc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">marker</span><span class="op">$</span><span class="va">channel_desc</span>, <span class="st">"_"</span><span class="op">)</span>, <span class="st">"["</span>, <span class="fl">1</span><span class="op">)</span></span>
<span class="r-in"><span class="va">marker</span> <span class="op">&lt;-</span></span>
<span class="r-in"> <span class="va">marker</span> <span class="op">%&gt;%</span></span>
<span class="r-in"> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pvalue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">pvalue</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">1e-300</span>, <span class="va">marker</span><span class="op">$</span><span class="va">pvalue</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span class="r-in"> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">channel_desc2</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span class="r-in"> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mean_scaled <span class="op">=</span> <span class="fu">fcexpr</span><span class="fu">:::</span><span class="fu">min.max.normalization</span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu">ggplot</span><span class="op">(</span><span class="va">marker</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">channel_desc2</span>, fill <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">pvalue</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">geom_tile</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">diff_sign</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu">ggplot</span><span class="op">(</span><span class="va">marker</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">channel_desc2</span>, fill <span class="op">=</span> <span class="va">mean_diff</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">geom_tile</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">diff_sign</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu">ggplot</span><span class="op">(</span><span class="va">marker</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">channel_desc2</span>, fill <span class="op">=</span> <span class="va">mean_scaled</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">geom_tile</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu">ggplot</span><span class="op">(</span><span class="va">marker</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_diff</span>, y <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">pvalue</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">channel_desc2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co">#color = channel_desc2,</span></span>
<span class="r-in"> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"cluster markers (vs all other cells each)"</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span>max.overlaps <span class="op">=</span> <span class="fl">20</span>, show.legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">theme</span><span class="op">(</span>panel.grid.minor.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, panel.grid.minor.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, panel.grid.major.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, strip.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"hotpink2"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span>, col <span class="op">=</span> <span class="st">"tomato2"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">100</span>, col <span class="op">=</span> <span class="st">"tomato2"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in"> <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"> <span class="co">##############################################</span></span>
<span class="r-in"> <span class="co">### find clusters which may be subject #######</span></span>
<span class="r-in"> <span class="co">### to bi- or multimodality in any channel ###</span></span>
<span class="r-in"> <span class="co">##############################################</span></span>
<span class="r-in"> <span class="co"># make one data frame</span></span>
<span class="r-in"> <span class="va">marker_all</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dr</span><span class="op">[[</span><span class="st">"marker"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dr</span><span class="op">[[</span><span class="st">"marker"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"marker_table"</span><span class="op">]</span><span class="op">]</span>, clustering <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"> <span class="co"># sort by diptest p value; or low p indicates bi- or multimodality</span></span>
<span class="r-in"> <span class="va">marker_all</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">marker_all</span>, <span class="va">diptest_p</span><span class="op">)</span></span>
<span class="r-in"> <span class="co"># see ?diptest::dip.test</span></span>
<span class="r-in"> <span class="co"># multimodality indicates heterogeneity within in the cluster</span></span>
<span class="r-in"> <span class="co"># and may justify to separate that cluster further into sub-clusters</span></span>
<span class="r-in"> <span class="co"># this depends on the interpretation of the scientist though</span></span>
<span class="r-in"></span>
<span class="r-in"></span>
<span class="r-in"><span class="op">}</span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Christopher Mark Skopnik.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer></div>

  


  

  </body></html>

